apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: financial-news-routes
  namespace: financial-news
spec:
  hosts:
    - "*"  # Development
    # - "your-actual-domain.com"  # Production
  gateways:
    - financial-news-gateway
  http:
    # ----------------------------------------
    # Global CORS (for OPTIONS preflight)
    # ----------------------------------------
    - match:
        - method:
            exact: OPTIONS
      corsPolicy:
        allowOrigins:
          # For development
          - exact: "http://localhost:3000"
          - exact: "http://localhost:3001"
          # For production - specify actual origins
          # - exact: "https://your-frontend.com"
        allowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        allowHeaders:
          - content-type
          - authorization
          - x-request-id
        maxAge: "24h"
        allowCredentials: true
      route:
        - destination:
            host: market-impact
            port:
              number: 8082

    # ----------------------------------------
    # MARKET IMPACT SERVICE (Main UI)
    # ----------------------------------------
    - name: "market-impact-ui"
      match:
        - uri:
            prefix: "/market-impact"
        - uri:
            exact: "/"
      route:
        - destination:
            host: market-impact
            port:
              number: 8082
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure

    # ----------------------------------------
    # ALERT SERVICE API
    # ----------------------------------------
    - name: "alert-service-api"
      match:
        - uri:
            prefix: "/api/alerts"
      route:
        - destination:
            host: alert-signal
            port:
              number: 8081
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s

    # ----------------------------------------
    # NEWS INGESTION API
    # ----------------------------------------
    - name: "news-ingestion-api"
      match:
        - uri:
            prefix: "/api/news"
      route:
        - destination:
            host: news-ingestion
            port:
              number: 4001
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s

    # ----------------------------------------
    # NLP HEALTH CHECK
    # ----------------------------------------
    - name: "nlp-health"
      match:
        - uri:
            prefix: "/api/nlp/health"
      rewrite:
        uri: "/health"
      route:
        - destination:
            host: nlp-processing
            port:
              number: 8080
          weight: 100
      timeout: 10s

    # ----------------------------------------
    # ACTUATOR ENDPOINTS (Health/Metrics)
    # ----------------------------------------
    - name: "actuator-endpoints"
      match:
        - uri:
            prefix: "/actuator"
      route:
        - destination:
            host: market-impact
            port:
              number: 8082
          weight: 100
      timeout: 10s